#!/bin/bash
# QUICK START: Run Enhanced Taxi Installer with Docker Permission Recovery
# This script now includes automatic detection and recovery for Docker permission issues

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Taxi System Enhanced Installer (with Docker Permission Fix)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… Enhanced Features:"
echo "   â€¢ Automatic Docker permission detection"
echo "   â€¢ Interactive recovery menu if permission denied"
echo "   â€¢ Auto-fix: Add taxi user to docker group"
echo "   â€¢ Retry logic on Docker service startup"
echo ""
echo "ğŸ“ When prompted about Docker permissions:"
echo "   Select Option 1 to auto-fix (RECOMMENDED)"
echo "   This adds the 'taxi' user to the docker group"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Option 1: Download and run in one command (recommended for fresh installs)
echo "ğŸš€ OPTION 1: One-liner (Fresh Install)"
echo "   Copy and paste this in your Ubuntu server terminal:"
echo ""
echo "   wget -q -O - https://raw.githubusercontent.com/Boris8800/Proyecto/main/install-taxi-system.sh | bash"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Option 2: Install to system command
echo "ğŸš€ OPTION 2: System Command (Persistent)"
echo "   Make the installer available as system command:"
echo ""
echo "   sudo curl -L https://raw.githubusercontent.com/Boris8800/Proyecto/main/install-taxi-system.sh -o /usr/local/bin/taxi-install && sudo chmod +x /usr/local/bin/taxi-install"
echo ""
echo "   Then run anytime with:"
echo "   taxi-install"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Option 3: Using tmux for persistent session
echo "ğŸš€ OPTION 3: Persistent Session (Handles Disconnects)"
echo "   If using SSH and worried about disconnects (e.g., PuTTY):"
echo ""
echo "   tmux new-session -d -s taxi-install 'wget -q -O - https://raw.githubusercontent.com/Boris8800/Proyecto/main/install-taxi-system.sh | bash | tee /var/log/install-taxi.log'"
echo ""
echo "   Monitor progress:"
echo "   tmux attach-session -t taxi-install"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Option 4: Manual download and run
echo "ğŸš€ OPTION 4: Manual Download"
echo "   For more control over the installation:"
echo ""
echo "   curl -L https://raw.githubusercontent.com/Boris8800/Proyecto/main/install-taxi-system.sh -o install-taxi-system.sh"
echo "   chmod +x install-taxi-system.sh"
echo "   ./install-taxi-system.sh"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Show expected prompts
echo "ğŸ“‹ What to Expect During Installation:"
echo ""
echo "   1. System package installation (Docker, Nginx, PostgreSQL, Redis)"
echo ""
echo "   2. Docker permission check:"
echo "      [WARN] Docker permission issue detected for user: taxi"
echo "      Options:"
echo "        1) Auto-fix: Add taxi to docker group (RECOMMENDED)"
echo "        2) Skip: Continue without fixing"
echo "        3) Exit: Stop installation"
echo ""
echo "      â†’ Choose 1 (auto-fix is recommended)"
echo ""
echo "   3. Docker services starting:"
echo "      - PostgreSQL 15 (database)"
echo "      - Redis 7 (cache)"
echo "      - Node.js API (port 3000)"
echo "      - Admin panel (port 8080)"
echo ""
echo "   4. Installation complete:"
echo "      âœ… INSTALACIÃ“N COMPLETA"
echo "      ğŸŒ API:         http://[YOUR_IP]:3000"
echo "      ğŸ“Š Admin Panel: http://[YOUR_IP]:8080"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Verify endpoints
echo "âœ… After Installation:"
echo ""
echo "   1. Check Docker containers running:"
echo "      docker ps"
echo ""
echo "   2. View API:"
echo "      curl http://localhost:3000"
echo ""
echo "   3. Check PostgreSQL:"
echo "      docker exec postgres15 psql -U admin -d taxi -c '\\dt'"
echo ""
echo "   4. View logs:"
echo "      tail -f /var/log/install-taxi.log"
echo "      tail -f /var/log/nginx/error.log"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Troubleshooting
echo "âŒ If Something Goes Wrong:"
echo ""
echo "   Docker permissions still denied:"
echo "   â†’ sudo usermod -aG docker taxi && newgrp docker"
echo ""
echo "   Port conflicts:"
echo "   â†’ sudo fuser -k 80/tcp 443/tcp"
echo ""
echo "   Restart Docker services:"
echo "   â†’ cd /home/taxi/app && sudo -u taxi docker-compose restart"
echo ""
echo "   Full reinstall:"
echo "   â†’ docker system prune -a"
echo "   â†’ ./install-taxi-system.sh"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ¯ RECOMMENDED: Copy and paste Option 1 one-liner to start"
echo ""
